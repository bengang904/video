<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频文件信息面板</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            padding: 10px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 12px;
        }
        h2 {
            margin-top: 0;
            color: #0d47a1;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .file-upload-container {
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        .hidden-by-url {
            display: none !important;
        }
        #fileInput {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .custom-file-button {
            background-color: #1976d2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .custom-file-button:hover {
            background-color: #1565c0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #mediaDisplay {
            display: none;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        #videoContainer {
            width: 100%;
        }
        #videoPlayer {
            width: 100%;
            max-height: 560px;
            background-color: #000;
            border-radius: 8px;
        }
        
        .plyr--full-screen {
            border-radius: 0 !important;
        }
        .plyr--video {
            border-radius: 8px;
        }


        #infoPanel {
            width: 100%;
            padding: 10px 0;
            margin-top: -10px;
        }
        #videoTitle {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }
        .metadata-row {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            padding: 15px 0;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .metadata-row:last-of-type {
            border-bottom: 1px solid #e0e0e0;
        }

        .metadata-item {
            display: flex;
            flex-direction: column;
            padding: 5px 0;
            flex-grow: 1;
            min-width: 150px;
        }
        .full-row-item {
            width: 100%;
            padding: 15px 0;
        }
        .full-row-item .metadata-value {
             background-color: #f5f5f5;
             padding: 15px;
             border-radius: 6px;
             line-height: 1.6;
             font-weight: 400;
             font-size: 16px;
        }

        .metadata-label {
            font-size: 14px;
            color: #606060;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .metadata-value {
            font-size: 18px;
            color: #030303;
            font-weight: 600;
            word-break: break-all;
        }
        .metadata-value:empty::before {
              content: 'N/A';
             color: #aaa;
             font-style: italic;
             font-weight: 400;
             font-size: 16px;
        }

        #statusMessage {
            display: none; 
        }

        @media (max-width: 768px) {
             .metadata-item {
                 min-width: 45%;
             }
        }
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            #videoTitle {
                font-size: 24px;
            }
            .metadata-row {
                flex-direction: column;
                gap: 5px;
                padding: 10px 0;
            }
            .metadata-item {
                width: 100%;
                border-top: none;
                padding: 5px 0;
            }
            .full-row-item {
                 padding: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="statusMessage"></div>

        <div class="file-upload-container" id="fileUploadContainer">
            <button class="custom-file-button" id="fileButton">选择 MP4 / WebM 文件</button>
            <input id="fileInput" type="file" accept="video/mp4,video/webm">
        </div>

        <div id="mediaDisplay">
            <div id="videoContainer">
                <video id="videoPlayer" controls></video>
            </div>

            <div id="infoPanel">
                <h1 id="videoTitle"></h1>

                <div class="metadata-row">
                    <div class="metadata-item">
                        <span class="metadata-label">作者 / Author</span>
                        <span class="metadata-value" id="artistValue"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">专辑 / Album</span>
                        <span class="metadata-value" id="albumValue"></span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">上传时间 / Upload Date</span>
                        <span class="metadata-value" id="yearValue"></span>
                    </div>
                </div>

                <div class="metadata-row">
                    <div class="metadata-item full-row-item">
                        <span class="metadata-label">描述 / Comment</span>
                        <span class="metadata-value" id="commentValue"></span>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        class VideoInfoApp {
            constructor() {
                this.fileInput = document.getElementById('fileInput');
                this.fileButton = document.getElementById('fileButton');
                this.fileUploadContainer = document.getElementById('fileUploadContainer');
                this.mediaDisplay = document.getElementById('mediaDisplay');
                this.videoPlayerElement = document.getElementById('videoPlayer'); 
                this.videoTitleElement = document.getElementById('videoTitle');
                this.statusMessage = document.getElementById('statusMessage');
                this.coverUrl = null;

                this.TAG_ELEMENT_MAP = {
                    'title': this.videoTitleElement,
                    'artist': document.getElementById('artistValue'),
                    'album': document.getElementById('albumValue'),
                    'comment': document.getElementById('commentValue'),
                    'year': document.getElementById('yearValue'),
                };
                
                this.hasPlaybackFailed = false;

                const controls = [
                    'play-large', 
                    'restart', 
                    'rewind', 
                    'play', 
                    'fast-forward', 
                    'progress', 
                    'current-time', 
                    'duration',
                    'settings', 
                    'pip', 
                    'fullscreen', 
                ];

                this.player = new Plyr(this.videoPlayerElement, { controls });
                
                this.initListeners();
                this.clearMetadataDisplay();
                this.checkUrlParams(); 
            }

            initListeners() {
                this.fileButton.addEventListener('click', () => {
                    this.fileInput.click();
                });
                this.fileInput.addEventListener('change', this.onFileChange.bind(this));
                this.videoPlayerElement.addEventListener('error', this.onVideoError.bind(this));
            }

            clearMetadataDisplay() {
                for (const key in this.TAG_ELEMENT_MAP) {
                    this.TAG_ELEMENT_MAP[key].textContent = '';
                }
                this.mediaDisplay.style.display = 'none';
                
                this.player.source = {
                    type: 'video',
                    sources: [{ src: '', type: 'video/mp4' }]
                };
                this.videoPlayerElement.removeAttribute('src');
                this.videoPlayerElement.removeAttribute('poster'); 
                this.coverUrl = null;
                this.hasPlaybackFailed = false;
            }

            setStatus(message, isError = false) {
                 if (isError) {
                     console.error(message);
                 } else {
                     console.log(message);
                 }
            }

            checkUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const fileUrl = params.get('url'); 

                if (fileUrl) {
                    this.fileUploadContainer.classList.add('hidden-by-url');
                    this.setStatus(`正在从 URL 加载视频文件: ${fileUrl}`, false);
                    this.loadRemoteFile(fileUrl);
                } else {
                    this.setStatus('请选择一个本地视频文件进行分析', false);
                    this.fileUploadContainer.classList.remove('hidden-by-url');
                }
            }
            
            async loadRemoteFile(url) {
                this.coverUrl = null; 
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const blob = await response.blob();
                    
                    const mimeType = response.headers.get('Content-Type') || blob.type || 'video/mp4';
                    const filename = url.substring(url.lastIndexOf('/') + 1);

                    const remoteFile = new File([blob], filename, { type: mimeType });

                    this.readMetadata(remoteFile);
                    this.startPlayback(remoteFile);
                    this.setStatus(`成功加载文件: ${filename}`, false);

                } catch (error) {
                    this.clearMetadataDisplay();
                    this.setStatus(`加载 URL 文件错误。可能是路径错误、跨域（CORS）或网络问题。错误信息: ${error.message}`, true);
                    this.hasPlaybackFailed = true;
                }
            }

            onFileChange(event) {
                const uploadedFile = event.target.files[0];
                if (!uploadedFile) return;

                this.clearMetadataDisplay();
                this.setStatus(`正在处理本地文件: ${uploadedFile.name}`, false);

                this.readMetadata(uploadedFile);
                this.startPlayback(uploadedFile);
            }

            arrayBufferToBase64(buffer, mime) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return `data:${mime};base64,${btoa(binary)}`;
            }

            readMetadata(file) {
                jsmediatags.read(file, {
                    onSuccess: tag => {
                        const t = tag.tags;

                        const titleValue = t['title'] || file.name.replace(/\.[^/.]+$/, "");
                        this.videoTitleElement.textContent = titleValue || '未找到标题';

                        this.TAG_ELEMENT_MAP.artist.textContent = t['artist'] || '';
                        this.TAG_ELEMENT_MAP.album.textContent = t['album'] || '';
                        this.TAG_ELEMENT_MAP.comment.textContent = t['comment'] || t['description'] || '';

                        let dateString = (t['year'] || t['recording_date'] || '').toString();
                        if (dateString.length >= 8) {
                            dateString = dateString.replace(/(\d{4})(\d{2})(\d{2})/, '$1年$2月$3日');
                        } else if (dateString.length === 4) {
                            dateString = dateString + '年';
                        }
                        this.TAG_ELEMENT_MAP.year.textContent = dateString || '';
                        
                        const picture = t.picture;
                        console.log("--- 封面数据排查结果 ---");
                        console.log("t.picture 对象:", picture);
                        
                        if (picture) {
                            try {
                                const buffer = picture.data;
                                const mime = picture.format;
                                this.coverUrl = this.arrayBufferToBase64(buffer, mime);
                                console.log("图片格式 (MIME):", mime);
                                console.log("图片数据长度 (Bytes):", buffer.length);
                                this.setStatus(`成功提取封面 (${mime})。`, false);
                            } catch (e) {
                                console.error("Base64 转换失败:", e);
                                this.setStatus('警告：无法处理内嵌封面数据，转换失败。', false);
                                this.coverUrl = null;
                            }
                        } else {
                            this.coverUrl = null;
                            this.setStatus('信息：文件中未检测到内嵌封面。', false);
                        }
                        console.log("------------------------");
                    },
                    onError: err => {
                        this.videoTitleElement.textContent = file.name.replace(/\.[^/.]+$/, "");
                        this.setStatus("警告：元数据读取失败。部分信息可能缺失。", false);
                    }
                });
            }
            
            startPlayback(file) {
                const currentSrc = this.videoPlayerElement.src;
                if (currentSrc && currentSrc.startsWith('blob:')) {
                    URL.revokeObjectURL(currentSrc);
                }

                try {
                    const videoURL = URL.createObjectURL(file);

                    if (this.coverUrl) {
                        this.videoPlayerElement.setAttribute('poster', this.coverUrl);
                    } else {
                        this.videoPlayerElement.removeAttribute('poster');
                    }

                    this.player.source = {
                        type: 'video',
                        title: this.videoTitleElement.textContent,
                        sources: [
                            {
                                src: videoURL,
                                type: file.type || 'video/mp4',
                            },
                        ],
                    };
                    
                    this.player.stop(); 
                    this.videoPlayerElement.removeAttribute('autoplay'); 
                    this.mediaDisplay.style.display = 'flex';

                } catch (e) {
                    this.mediaDisplay.style.display = 'none';
                    this.clearMetadataDisplay();
                    this.setStatus('错误：视频播放设置失败。文件可能损坏或格式不受支持。', true);
                    this.hasPlaybackFailed = true;
                }
            }

            onVideoError() {
                if (this.hasPlaybackFailed) {
                    return; 
                }
                
                const error = this.player.media.error || this.videoPlayerElement.error;
                const errorMessage = error ? error.message : 'Unknown Error';
                this.setStatus('Fatal video playback error: ' + errorMessage, true);
                
                const currentSrc = this.videoPlayerElement.src;
                if (currentSrc && currentSrc.startsWith('blob:')) {
                    URL.revokeObjectURL(currentSrc);
                }
                
                this.player.destroy(); 
                this.videoPlayerElement.removeAttribute('src'); 
                this.mediaDisplay.style.display = 'none';
                this.clearMetadataDisplay();
                this.hasPlaybackFailed = true;

                this.player = new Plyr(this.videoPlayerElement);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new VideoInfoApp();
        });
    </script>
</body>
</html>